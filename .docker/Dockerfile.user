# Build stage
FROM maven:3.9-eclipse-temurin-21 AS builder

WORKDIR /build

COPY pom.xml .
COPY common-lib ./common-lib
COPY user-service ./user-service

RUN mvn clean package -DskipTests=true --file user-service/pom.xml

# Runtime stage
FROM eclipse-temurin:21-jre-noble

WORKDIR /app

COPY --from=builder /build/user-service/target/*.jar app.jar

EXPOSE 8082

ENV JAVA_OPTS="-Xmx512m -Xms256m -XX:+UseG1GC -XX:MaxGCPauseMillis=200"

HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD java -cp app.jar org.springframework.boot.loader.JarLauncher || exit 1

ENTRYPOINT exec java $JAVA_OPTS org.springframework.boot.loader.JarLauncher
